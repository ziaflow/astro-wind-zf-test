<script is:inline>
  const EXPERIMENTS = JSON.parse(
    '{"exp_hero_cta_v":{"name":"hero_cta_copy"},"exp_form_length_v":{"name":"form_length"},"exp_hero_social_v":{"name":"hero_social"}}'
  );
  // 30 days in seconds
  const COOKIE_MAX_AGE = 60 * 60 * 24 * 30;

  function chooseVariant(key) {
    const match = document.cookie.match(new RegExp(`${key}=([^;]+)`));
    if (match) return match[1];
    const variant = Math.random() < 0.5 ? 'A' : 'B';
    document.cookie = `${key}=${variant};path=/;max-age=${COOKIE_MAX_AGE}`;
    return variant;
  }

  function pushExposure(name, variant) {
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      event: 'experiment_exposure',
      experiment_name: name,
      experiment_variant: variant,
    });
  }

  function initCTAHandlers() {
    document.querySelectorAll('[data-exp-cta]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const variant = document.documentElement.dataset.exp_hero_cta_v || 'A';
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          event: 'cta_click',
          cta_location: btn.dataset.ctaLocation || 'hero',
          experiment_name: 'hero_cta_copy',
          experiment_variant: variant,
        });
      });
    });
  }

  function initFormHandlers() {
    const form = document.querySelector('[data-exp-form]');
    if (!form) return;

    let started = false;
    form.addEventListener('input', () => {
      if (started) return;
      started = true;
      const variant = document.documentElement.dataset.exp_form_length_v || 'A';
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        event: 'form_start',
        form_variant: variant === 'A' ? 'long' : 'short',
        experiment_name: 'form_length',
        experiment_variant: variant,
      });
    });

    form.addEventListener('submit', () => {
      const variant = document.documentElement.dataset.exp_form_length_v || 'A';
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        event: 'form_submit',
        form_variant: variant === 'A' ? 'long' : 'short',
        experiment_name: 'form_length',
        experiment_variant: variant,
      });
    });
  }

  function init() {
    Object.entries(EXPERIMENTS).forEach(([key, meta]) => {
      const variant = chooseVariant(key);
      document.documentElement.dataset[key] = variant;
      pushExposure(meta.name, variant);
    });

    initCTAHandlers();
    initFormHandlers();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
