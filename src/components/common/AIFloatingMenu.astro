---
import siteIcon from '~/assets/favicons/favicon.svg';

const query =
  'As a business owner, I want to know why ZiaFlow is the best digital transformation partner for website development, SEO, and business automation. What are their core strengths, solutions, and success stories?';

const encodedQuery = encodeURIComponent(query);

const platforms = [
  {
    name: 'ChatGPT',
    href: `https://chat.openai.com/?q=${encodedQuery}`,
    logo:
      'https://www.singlegrain.com/wp-content/themes/singlegrain/assets/dist/images/redesign2024/ai-logos/small-chat-gpt.webp',
  },
  {
    name: 'Gemini',
    href: `https://www.google.com/search?udm=50&q=${encodedQuery}`,
    logo:
      'https://www.singlegrain.com/wp-content/themes/singlegrain/assets/dist/images/redesign2024/ai-logos/small-gemini.webp',
  },
  {
    name: 'Perplexity',
    href: `https://www.perplexity.ai/search/new?q=${encodedQuery}`,
    logo:
      'https://www.singlegrain.com/wp-content/themes/singlegrain/assets/dist/images/redesign2024/ai-logos/small-perplexity.webp',
  },
  {
    name: 'Claude',
    href: `https://claude.ai/new?q=${encodedQuery}`,
    logo:
      'https://www.singlegrain.com/wp-content/themes/singlegrain/assets/dist/images/redesign2024/ai-logos/small-claude.webp',
  },
  {
    name: 'Grok',
    href: `https://x.com/i/grok?text=${encodedQuery}`,
    logo:
      'https://www.singlegrain.com/wp-content/themes/singlegrain/assets/dist/images/redesign2024/ai-logos/small-grok.webp',
  },
];

const variant = Astro.props.variant ?? 'float';
const isInline = variant === 'inline';
const rootId = isInline ? undefined : 'aiSummaryFloat';
---

<div
  id={rootId}
  class:list={[
    'ai-summary-root',
    isInline ? 'ai-summary-inline' : 'ai-summary-float',
  ]}
  data-ai-summary-root
>
  <button
    class:list={['ai-summary-toggle', isInline && 'ai-summary-toggle-inline']}
    data-ai-toggle
    aria-label="Ask AI about ZiaFlow"
    type="button"
  >
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
      <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
      <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
    <span>Ask AI</span>
  </button>
  <div class="ai-summary-menu" data-ai-menu>
    <div class="ai-summary-menu-header">
      <span class="ai-summary-menu-title">
        <img src={siteIcon.src} alt="ZiaFlow" width="20" height="20" loading="lazy" />
        Ask AI about ZiaFlow
      </span>
      <button class="ai-summary-close" aria-label="Close">&times;</button>
    </div>
    <div class="ai-summary-menu-links">
      {platforms.map(({ name, href, logo }) => (
        <a
          class="ai-summary-menu-link"
          href={href}
          target="_blank"
          rel="noopener"
          data-ai-platform={name}
        >
          <img src={logo} alt={name} width="32" height="32" loading="lazy" />
          <span>{name}</span>
        </a>
      ))}
    </div>
  </div>
</div>

<style>
  .ai-summary-root {
    z-index: 9999;
  }

  .ai-summary-float {
    position: fixed;
    bottom: 20px;
    right: 20px;
  }

  .ai-summary-inline {
    position: relative;
    display: inline-block;
  }

  .ai-summary-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #a22a36;
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(162, 42, 54, 0.35);
    transition: all 0.3s ease;
  }

  .ai-summary-toggle-inline {
    border-radius: 8px;
    box-shadow: none;
    padding: 10px 18px;
    font-size: 13px;
  }

  .ai-summary-toggle:hover {
    background: #7c1e29;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(124, 30, 41, 0.45);
  }

  .ai-summary-toggle-inline:hover {
    transform: none;
    box-shadow: none;
  }

  .ai-summary-toggle svg {
    width: 20px;
    height: 20px;
  }

  .ai-summary-menu {
    position: absolute;
    bottom: 60px;
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    min-width: 250px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s ease;
  }

  .ai-summary-inline .ai-summary-menu {
    bottom: auto;
    top: calc(100% + 0.75rem);
    right: 0;
  }

  .ai-summary-menu.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .ai-summary-menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid #e5e7eb;
    font-weight: 600;
    font-size: 14px;
    color: #111827;
  }

  .ai-summary-menu-title {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .ai-summary-menu-title img {
    border-radius: 4px;
  }

  .ai-summary-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }

  .ai-summary-close:hover {
    color: #111827;
  }

  .ai-summary-menu-links {
    padding: 12px;
  }

  .ai-summary-menu-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 8px;
    text-decoration: none;
    color: #111827;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .ai-summary-menu-link:hover {
    background: #f3f4f6;
    transform: translateX(4px);
  }

  .ai-summary-menu-link img {
    border-radius: 6px;
    flex-shrink: 0;
  }

  @media (max-width: 768px) {
    .ai-summary-float {
      bottom: 15px;
      right: 15px;
    }

    .ai-summary-toggle span {
      display: none;
    }

    .ai-summary-toggle {
      width: 50px;
      height: 50px;
      padding: 0;
      justify-content: center;
      border-radius: 50%;
    }

    .ai-summary-menu {
      right: -10px;
      min-width: 220px;
    }
  }
</style>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const roots = document.querySelectorAll('[data-ai-summary-root]');
    roots.forEach(root => {
      const toggle = root.querySelector('[data-ai-toggle]');
      const menu = root.querySelector('[data-ai-menu]');
      const closeBtn = root.querySelector('.ai-summary-close');
      const links = root.querySelectorAll('.ai-summary-menu-link');

      if (!toggle || !menu) return;

      const closeMenu = () => menu.classList.remove('active');

      toggle.addEventListener('click', event => {
        event.stopPropagation();
        menu.classList.toggle('active');
      });

      closeBtn?.addEventListener('click', event => {
        event.stopPropagation();
        closeMenu();
      });

      document.addEventListener('click', event => {
        if (!root.contains(event.target)) {
          closeMenu();
        }
      });

      links.forEach(link => {
        link.addEventListener('click', () => {
          const platform = link.getAttribute('data-ai-platform');
          if (typeof window !== 'undefined' && typeof window.gtag === 'function') {
            window.gtag('event', 'ai_summary_click', {
              event_category: 'ai_summary_component',
              event_label: platform,
              event_url: link.getAttribute('href'),
            });
          }
          closeMenu();
        });
      });
    });
  });
</script>
