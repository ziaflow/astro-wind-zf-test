---
/**
 * AuditBookingForm - Embedded lead capture form for audit booking
 * Submits to a serverless function or email handler
 * Fires dataLayer event on submission for GTM tracking
 */

interface Props {
  id?: string;
  class?: string;
}

const { id = 'audit-form', class: className = '' } = Astro.props;
---

<div class:list={['audit-booking-form w-full max-w-xl mx-auto', className]} {id}>
  <div class="bg-white dark:bg-slate-900 rounded-lg shadow-lg p-8 border border-slate-200 dark:border-slate-700">
    <h2 class="text-2xl font-bold mb-2 text-slate-900 dark:text-white">Book Your Free Growth Audit</h2>
    <p class="text-slate-600 dark:text-slate-400 mb-6 text-sm">
      Fill out the form below. We'll deliver a personalized video audit within 48 hours.
    </p>

    <form
      id="audit-booking-form"
      method="POST"
      action="/_api/forms/audit"
      class="space-y-4"
      data-ga-event="form_submission"
      data-ga-label="audit_booking"
    >
      <input type="hidden" name="form_type" value="audit_booking" />
      <input type="hidden" name="from_email" value="info@ziaflow.com" />

      <!-- First Name -->
      <div>
        <label for="first_name" class="block text-sm font-medium text-slate-900 dark:text-white mb-1">
          First Name *
        </label>
        <input
          type="text"
          id="first_name"
          name="first_name"
          required
          placeholder="John"
          class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
        />
      </div>

      <!-- Last Name -->
      <div>
        <label for="last_name" class="block text-sm font-medium text-slate-900 dark:text-white mb-1">
          Last Name *
        </label>
        <input
          type="text"
          id="last_name"
          name="last_name"
          required
          placeholder="Doe"
          class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
        />
      </div>

      <!-- Company Name -->
      <div>
        <label for="company_name" class="block text-sm font-medium text-slate-900 dark:text-white mb-1">
          Company Name *
        </label>
        <input
          type="text"
          id="company_name"
          name="company_name"
          required
          placeholder="Acme Corp"
          class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
        />
      </div>

      <!-- Email -->
      <div>
        <label for="email" class="block text-sm font-medium text-slate-900 dark:text-white mb-1">
          Email *
        </label>
        <input
          type="email"
          id="email"
          name="email"
          required
          placeholder="john@example.com"
          class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
        />
      </div>

      <!-- Phone Number -->
      <div>
        <label for="phone" class="block text-sm font-medium text-slate-900 dark:text-white mb-1">
          Phone Number *
        </label>
        <input
          type="tel"
          id="phone"
          name="phone"
          required
          placeholder="+1 (555) 123-4567"
          class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
        />
      </div>

      <!-- Message -->
      <div>
        <label for="message" class="block text-sm font-medium text-slate-900 dark:text-white mb-1">
          Message (optional)
        </label>
        <textarea
          id="message"
          name="message"
          rows="4"
          placeholder="Tell us about your current SEO/conversion challenges..."
          class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 resize-none"
        />
      </div>

      <!-- Privacy Notice -->
      <p class="text-xs text-slate-500 dark:text-slate-400">
        We respect your privacy. Your information will only be used to send you the audit and occasional updates.
      </p>

      <!-- Submit Button -->
      <button
        type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-md transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400"
        data-ga-event="form_submit_click"
        data-ga-label="audit_booking_submit"
      >
        Book My Free Audit
      </button>
    </form>

    <!-- Success Message (hidden, shown on submit) -->
    <div
      id="audit-form-success"
      class="hidden mt-4 p-4 bg-green-100 dark:bg-green-900 border border-green-300 dark:border-green-700 rounded-md"
    >
      <p class="text-green-800 dark:text-green-100 font-medium">
        Thanks! We've received your request. Check your email for the audit within 48 hours.
      </p>
    </div>
  </div>
</div>

<script is:inline>
  const form = document.getElementById('audit-booking-form');
  const successDiv = document.getElementById('audit-form-success');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const data = Object.fromEntries(formData);

      try {
        // Push to dataLayer for GTM tracking
        if (window.dataLayer) {
          window.dataLayer.push({
            event: 'form_submission',
            form_name: 'audit_booking',
            email: data.email,
            company: data.company_name,
          });
        }

        // Submit form to serverless handler
        const response = await fetch('/_api/forms/audit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          // Show success message
          form.classList.add('hidden');
          successDiv.classList.remove('hidden');

          // Optional: Redirect after 2 seconds or perform other actions
          // window.location.href = '/thank-you';
        } else {
          alert('Something went wrong. Please try again.');
        }
      } catch (error) {
        console.error('Form submission error:', error);
        alert('Error submitting form. Please try again.');
      }
    });
  }
</script>

<style>
  input:disabled,
  textarea:disabled {
    background-color: #f3f4f6;
    cursor: not-allowed;
  }
</style>
