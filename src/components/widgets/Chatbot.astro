---
/**
 * Chatbot Widget - Custom Microsoft Web Chat
 * Adapted from Microsoft Copilot Studio custom website sample
 */

interface Props {
  // Keeping interface for compatibility, though styles are largely hardcoded in this version
  // layout adjustments can be made in the <style> block
}
---

<!-- Load Web Chat SDK -->
<script is:inline src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

<div id="chatbot-container">
  <div id="chatbot-popup" role="complementary" aria-label="Chat Assistant">
    <div id="chatbot-header">
      <div class="header-title">
        <svg
          class="chat-icon"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span>Contoso Assistant</span>
      </div>
      <div class="header-buttons">
        <button class="icon-button" id="restart-button" aria-label="Restart Conversation">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
            <path d="M3 3v5h5"></path>
          </svg>
        </button>
        <button class="icon-button" id="close-button" aria-label="Close Chat">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
    <div id="webchat" role="main"></div>
  </div>

  <button id="open-chat" aria-label="Open Chat Assistant">
    <svg
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true"
    >
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
  </button>
</div>

<script is:inline>
  // Wait for the Web Chat script to load if it hasn't already
  window.addEventListener('load', () => {
    let webChatInstance = null;
    let directLineUrl = null;

    // TODO: Replace with your token endpoint from Copilot Studio -> Channels -> Custom website
    const tokenEndpoint =
      'https://74aac72d5d06e23da1979c8ca34dc2.0b.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cre09_ZiaflowLeadCapture/directline/token?api-version=2022-03-01-preview';

    if (tokenEndpoint === '<YOUR TOKEN ENDPOINT>') {
      console.warn('Chatbot configuration: Please set the tokenEndpoint in src/components/widgets/Chatbot.astro');
    }

    const styleOptions = {
      accent: '#0078D4',
      autoScrollSnapOnPage: true,
      autoScrollSnapOnPageOffset: 0,
      avatarBorderRadius: '7%',
      avatarSize: 31,
      backgroundColor: '#e8e9eb',
      botAvatarBackgroundColor: '#ffffff00',
      botAvatarImage: 'https://powercatexternal.blob.core.windows.net/creatorkit/Assets/ChatbotLogoBlue.png',
      botAvatarInitials: 'B',
      bubbleAttachmentMaxWidth: 480,
      bubbleAttachmentMinWidth: 250,
      bubbleBackground: '#f0eded',
      bubbleBorderColor: '#f5f5f5',
      bubbleBorderRadius: 41,
      bubbleBorderStyle: 'solid',
      bubbleBorderWidth: 1,
      bubbleFromUserBackground: '#ebefff',
      bubbleFromUserBorderColor: '#f5f5f5',
      bubbleFromUserBorderRadius: 41,
      bubbleFromUserBorderStyle: 'solid',
      bubbleFromUserBorderWidth: 1,
      bubbleFromUserNubOffset: 0,
      bubbleFromUserNubSize: 0,
      bubbleFromUserTextColor: '#242424',
      bubbleImageHeight: 10,
      bubbleImageMaxHeight: 240,
      bubbleImageMinHeight: 240,
      bubbleMessageMaxWidth: 480,
      bubbleMessageMinWidth: 120,
      bubbleMinHeight: 50,
      bubbleNubOffset: 0,
      bubbleTextColor: '#242424',
      emojiSet: true,
      fontSizeSmall: '70%',
      hideUploadButton: false,
      messageActivityWordBreak: 'break-word',
      monospaceFont: 'Consolas',
      paddingRegular: 10,
      paddingWide: 10,
      primaryFont: null,
      sendBoxBackground: '#e8e9eb',
      sendBoxBorderTop: 'solid 1px #808080',
      sendBoxButtonColor: '#0078d4',
      sendBoxButtonColorOnHover: '#006cbe',
      sendBoxButtonShadeBorderRadius: 40,
      sendBoxButtonShadeColorOnHover: '',
      sendBoxHeight: 60,
      sendBoxPlaceholderColor: '#171616',
      sendBoxTextColor: '#2e2d2d',
      showAvatarInGroup: 'status',
      spinnerAnimationHeight: 16,
      spinnerAnimationPadding: 12,
      spinnerAnimationWidth: 16,
      subtleColor: '#000000FF',
      suggestedActionBackgroundColor: '#006FC4FF',
      suggestedActionBackgroundColorOnHover: '#0078D4',
      suggestedActionBorderColor: '',
      suggestedActionBorderRadius: 10,
      suggestedActionBorderWidth: 1,
      suggestedActionLayout: 'flow',
      suggestedActionTextColor: '#FFFFFFFF',
      typingAnimationBackgroundImage: "url('https://wpamelia.com/wp-content/uploads/2018/11/ezgif-2-6d0b072c3d3f.gif')",
      typingAnimationDuration: 5000,
      typingAnimationHeight: 20,
      typingAnimationWidth: 64,
      userAvatarBackgroundColor: '#222222',
      userAvatarImage: 'https://avatars.githubusercontent.com/u/8174072?v=4&size=64',
      userAvatarInitials: 'U',
    };
    const backgroundImage = '';

    const root = document.documentElement;
    root.style.setProperty('--primary-color', createGradient(styleOptions.accent));
    root.style.setProperty('--header-textColor', styleOptions.suggestedActionTextColor);
    if (backgroundImage) {
      const webchatElement = document.getElementById('webchat');
      if (webchatElement) {
        webchatElement.style.backgroundImage = `url(${backgroundImage})`;
        webchatElement.style.backgroundSize = 'cover';
        webchatElement.style.backgroundPosition = 'center';
        webchatElement.style.backgroundRepeat = 'no-repeat';
        const overlay = document.createElement('div');
        overlay.className = 'webchat-overlay';
        webchatElement.appendChild(overlay);
      }
    }

    function createGradient(baseColor) {
      const r = parseInt(baseColor.slice(1, 3), 16);
      const g = parseInt(baseColor.slice(3, 5), 16);
      const b = parseInt(baseColor.slice(5, 7), 16);
      const lighterColor = `#${Math.min(255, r + 30)
        .toString(16)
        .padStart(2, '0')}${Math.min(255, g + 30)
        .toString(16)
        .padStart(2, '0')}${Math.min(255, b + 30)
        .toString(16)
        .padStart(2, '0')}`;
      const darkerColor = `#${Math.max(0, r - 30)
        .toString(16)
        .padStart(2, '0')}${Math.max(0, g - 30)
        .toString(16)
        .padStart(2, '0')}${Math.max(0, b - 30)
        .toString(16)
        .padStart(2, '0')}`;
      return `linear-gradient(135deg, ${lighterColor}, ${baseColor}, ${darkerColor})`;
    }

    const environmentEndPoint = tokenEndpoint.slice(0, tokenEndpoint.indexOf('/powervirtualagents'));
    const apiVersion = tokenEndpoint.slice(tokenEndpoint.indexOf('api-version')).split('=')[1];
    const regionalChannelSettingsURL = `${environmentEndPoint}/powervirtualagents/regionalchannelsettings?api-version=${apiVersion}`;

    const popup = document.getElementById('chatbot-popup');
    const openButton = document.getElementById('open-chat');
    const closeButton = document.getElementById('close-button');
    const restartButton = document.getElementById('restart-button');

    function showChat() {
      popup.classList.add('visible');
      openButton.classList.add('hidden');
    }

    function hideChat() {
      popup.classList.remove('visible');
      openButton.classList.remove('hidden');
    }

    // Attach event listeners
    if (openButton) openButton.addEventListener('click', showChat);
    if (closeButton) closeButton.addEventListener('click', hideChat);
    if (restartButton) restartButton.addEventListener('click', restartConversation);

    function createCustomStore() {
      return window.WebChat.createStore({}, ({ dispatch }) => (next) => (action) => {
        if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
          dispatch({
            type: 'DIRECT_LINE/POST_ACTIVITY',
            meta: { method: 'keyboard' },
            payload: {
              activity: {
                channelData: { postBack: true }, // Ensure 'postBack' is set correctly for your bot's expectations
                name: 'startConversation',
                type: 'event',
              },
            },
          });
        }
        return next(action);
      });
    }

    async function restartConversation() {
      try {
        if (!directLineUrl) {
          console.error('DirectLine URL not initialized');
          return;
        }
        const response = await fetch(tokenEndpoint);
        if (!response.ok) throw new Error('Failed to fetch token');
        const conversationInfo = await response.json();
        if (!conversationInfo.token) {
          throw new Error('Failed to get conversation token');
        }
        const newDirectLine = window.WebChat.createDirectLine({
          domain: `${directLineUrl}v3/directline`,
          token: conversationInfo.token,
        });
        const webchatElement = document.getElementById('webchat');
        webChatInstance = window.WebChat.renderWebChat(
          {
            directLine: newDirectLine,
            styleOptions,
            store: createCustomStore(),
          },
          webchatElement
        );
      } catch (err) {
        console.error('Failed to restart conversation:', err);
      }
    }

    async function initializeChat() {
      try {
        if (!tokenEndpoint || tokenEndpoint.includes('YOUR TOKEN')) return;

        const response = await fetch(regionalChannelSettingsURL);
        if (!response.ok) throw new Error('Failed to fetch regional settings');
        const data = await response.json();
        directLineUrl = data.channelUrlsById.directline;
        if (!directLineUrl) {
          throw new Error('Failed to get DirectLine URL');
        }
        const conversationResponse = await fetch(tokenEndpoint);
        if (!conversationResponse.ok) throw new Error('Failed to fetch token');
        const conversationInfo = await conversationResponse.json();
        if (!conversationInfo.token) {
          throw new Error('Failed to get conversation token');
        }
        const directLine = window.WebChat.createDirectLine({
          domain: `${directLineUrl}v3/directline`,
          token: conversationInfo.token,
        });
        webChatInstance = window.WebChat.renderWebChat(
          {
            directLine,
            styleOptions,
            store: createCustomStore(),
          },
          document.getElementById('webchat')
        );
      } catch (err) {
        console.error('Failed to initialize chat:', err);
      }
    }

    initializeChat();
  });
</script>

<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #2b88d8, #0078d4, #006cbe);
    --chat-width: 450px;
    --chat-height: 520px;
    --header-height: 56px;
    --border-radius: 16px;
    --transition-speed: 0.3s;
  }

  /* Chatbot Styles */
  #chatbot-popup {
    display: none;
    position: fixed;
    bottom: 32px;
    right: 32px;
    width: var(--chat-width);
    height: var(--chat-height);
    background: white;
    border-radius: var(--border-radius);
    box-shadow:
      0 18px 40px -5px rgba(0, 0, 0, 0.2),
      0 15px 20px -5px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    opacity: 0;
    transform-origin: bottom right;
    transform: scale(0.95);
    transition: all var(--transition-speed) ease-in-out;
    z-index: 999;
  }

  #chatbot-popup.visible {
    display: block;
    opacity: 1;
    transform: scale(1);
  }

  #chatbot-header {
    background: var(--primary-gradient); /* Use variable or gradient */
    padding: 16px 20px;
    height: var(--header-height);
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white; /* Default text color */
  }

  .header-title {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 16px;
    font-weight: 500;
  }

  .header-buttons {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .icon-button {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .icon-button:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .icon-button:focus {
    outline: 2px solid rgba(255, 255, 255, 0.5);
    outline-offset: 2px;
  }

  #webchat {
    height: calc(100% - var(--header-height));
    background-color: #f9fafb;
    position: relative;
    overflow: hidden; /* Ensure content doesn't spill */
  }

  .webchat-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.85);
    pointer-events: none;
    z-index: 1;
  }

  #webchat > div {
    position: relative;
    z-index: 2;
  }

  #open-chat {
    position: fixed;
    bottom: 32px;
    right: 32px;
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--primary-gradient);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transition: all var(--transition-speed) ease-in-out;
    z-index: 998;
  }

  #open-chat.hidden {
    opacity: 0;
    transform: scale(0.95) translateY(10px);
    pointer-events: none;
  }

  #open-chat:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }

  #open-chat:focus {
    outline: 3px solid rgba(79, 70, 229, 0.5);
    outline-offset: 2px;
  }

  #open-chat svg {
    width: 28px;
    height: 28px;
    color: white;
    transition: transform 0.2s ease;
  }

  @media (max-width: 768px) {
    #chatbot-popup {
      width: 100%;
      height: 100%;
      bottom: 0;
      right: 0;
      border-radius: 0;
    }
  }
</style>
