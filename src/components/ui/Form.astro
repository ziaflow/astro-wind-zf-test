---
import Button from '~/components/ui/Button.astro';
import type { Form as Props } from '~/types';

const emailBackend = import.meta.env.EMAIL_BACKEND || 'web3forms';
const useNodemailer = emailBackend === 'nodemailer';

const {
  inputs = [],
  textarea,
  disclaimer,
  button = 'Contact us',
  description = '',
  action = useNodemailer ? '/api/contact' : 'https://api.web3forms.com/submit',
  method = 'POST',
  accessKey,
  redirect,
  subject = 'New Contact Request',
  fromName = 'ZiaFlow Website',
  formId,
  resultId,
  successMessage = 'Thanks! We received your message.',
  errorMessage = 'Something went wrong. Please try again.',
} = Astro.props as Props;

const resolvedAccessKey = accessKey || import.meta.env.WEB3FORMS_ACCESS_KEY || '';
const idSuffix = typeof crypto !== 'undefined' && 'randomUUID' in crypto ? crypto.randomUUID() : Math.random().toString(36).slice(2, 10);
const resolvedFormId = formId || `web3forms-form-${idSuffix}`;
const resolvedResultId = resultId || `${resolvedFormId}-result`;

if (!useNodemailer && !resolvedAccessKey) {
  console.warn('WEB3FORMS_ACCESS_KEY is not set. Web3Forms submissions will fail until it is configured.');
}
---

<form action={action} method={method} id={resolvedFormId} class="space-y-6">
  {!useNodemailer && <input type="hidden" name="access_key" value={resolvedAccessKey} />}
  {!useNodemailer && redirect && <input type="hidden" name="redirect" value={redirect} />}
  {!useNodemailer && <input type="hidden" name="subject" value={subject} />}
  {!useNodemailer && <input type="hidden" name="from_name" value={fromName} />}
  <input type="checkbox" name="botcheck" class="hidden" aria-hidden="true" tabindex="-1" />

  {
    inputs &&
      inputs.map(
        ({ type = 'text', name, label = '', autocomplete = 'on', placeholder = '', required = false }) =>
          name && (
            <div class="mb-6">
              {label && (
                <label for={name} class="block text-sm font-medium">
                  {label}
                </label>
              )}
              <input
                type={type}
                name={name}
                id={name}
                autocomplete={autocomplete}
                placeholder={placeholder}
                required={required}
                class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900"
              />
            </div>
          )
      )
  }

  {
    textarea && (
      <div>
        <label for="textarea" class="block text-sm font-medium">
          {textarea.label}
        </label>
        <textarea
          id="textarea"
          name={textarea.name ? textarea.name : 'message'}
          rows={textarea.rows ? textarea.rows : 4}
          placeholder={textarea.placeholder}
          class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900"
        />
      </div>
    )
  }

  {
    disclaimer && (
      <div class="mt-3 flex items-start">
        <div class="flex mt-0.5">
          <input
            id="disclaimer"
            name="disclaimer"
            type="checkbox"
            class="cursor-pointer mt-1 py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900"
          />
        </div>
        <div class="ml-3">
          <label for="disclaimer" class="cursor-pointer select-none text-sm text-gray-600 dark:text-gray-400">
            {disclaimer.label}
          </label>
        </div>
      </div>
    )
  }

  {
    button && (
      <div class="mt-10 grid">
        <Button variant="primary" type="submit">
          {button}
        </Button>
      </div>
    )
  }

  {
    description && (
      <div class="mt-3 text-center">
        <p class="text-sm text-gray-600 dark:text-gray-400">{description}</p>
      </div>
    )
  }

  <p id={resolvedResultId} class="text-base text-center text-gray-500"></p>
</form>

<script
  is:inline
  data-form-id={resolvedFormId}
  data-result-id={resolvedResultId}
  data-action-url={action}
  data-success-message={successMessage}
  data-error-message={errorMessage}
>
  const scriptEl = document.currentScript;
  const {
    formId: datasetFormId,
    resultId: datasetResultId,
    actionUrl,
    successMessage,
    errorMessage,
  } = scriptEl?.dataset ?? {};

  if (!datasetFormId || !datasetResultId || !actionUrl) {
    console.warn('Web3Forms script missing required dataset attributes');
  } else {
    const form = document.getElementById(datasetFormId);
    const resultEl = document.getElementById(datasetResultId);

    if (form && resultEl) {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        resultEl.textContent = 'Please wait...';
        resultEl.classList.remove('text-green-500', 'text-red-500');

        const formData = new FormData(form);
        const payload = JSON.stringify(Object.fromEntries(formData.entries()));

        try {
          const response = await fetch(actionUrl, {
            method: form.method,
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            },
            body: payload,
          });

          const data = await response.json();
          if (response.ok) {
            resultEl.textContent = data.message || successMessage || 'Thank you!';
            resultEl.classList.add('text-green-500');
            form.reset();
          } else {
            resultEl.textContent = data.message || errorMessage || 'Submission failed.';
            resultEl.classList.add('text-red-500');
          }
        } catch (error) {
          console.error('Form submission error:', error);
          resultEl.textContent = errorMessage || 'Something went wrong.';
          resultEl.classList.add('text-red-500');
        }

        setTimeout(() => {
          resultEl.textContent = '';
        }, 5000);
      });
    }
  }
</script>
